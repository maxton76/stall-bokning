rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================================================
    // AUTHENTICATION HELPERS
    // ============================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================================================
    // SYSTEM ROLE HELPERS (using correct 'systemRole' field)
    // ============================================================================

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // FIXED: Check 'systemRole' field instead of 'role'
    function hasRole(role) {
      return isAuthenticated() && userExists() && getUserData().systemRole == role;
    }

    function isSystemAdmin() {
      return hasRole('system_admin');
    }

    // Renamed to clarify this is a system-wide role check
    function hasStableOwnerRole() {
      return hasRole('stable_owner');
    }

    // ============================================================================
    // STABLE ACCESS HELPERS (ORGANIZATION-BASED)
    // ============================================================================
    // Note: Firebase linter may show warnings for 'request', 'exists', 'get'.
    // These are false positives - they are official Firestore Security Rules built-ins.
    //
    // Stable access is now determined via organization membership:
    // - stableAccess: 'all' grants access to all stables in the organization
    // - stableAccess: 'specific' + assignedStableIds grants access to listed stables

    // Check if user is the OWNER of a specific stable
    function isStableOwnerOf(stableId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/stables/$(stableId)) &&
        get(/databases/$(database)/documents/stables/$(stableId)).data.ownerId == request.auth.uid;
    }

    // Get organization member document for a stable's organization
    function getOrgMemberForStable(stableId) {
      let stable = get(/databases/$(database)/documents/stables/$(stableId)).data;
      let orgId = stable.organizationId;
      let memberId = request.auth.uid + '_' + orgId;
      return orgId != null && exists(/databases/$(database)/documents/organizationMembers/$(memberId))
        ? get(/databases/$(database)/documents/organizationMembers/$(memberId)).data
        : null;
    }

    // Check if user has access to a stable via organization membership
    function hasOrgStableAccess(stableId) {
      let member = getOrgMemberForStable(stableId);
      return member != null &&
             member.status == 'active' &&
             (member.stableAccess == 'all' ||
              (member.stableAccess == 'specific' && member.assignedStableIds.hasAny([stableId])));
    }

    // Check if user is an organization administrator with stable access
    function isOrgAdminForStable(stableId) {
      let member = getOrgMemberForStable(stableId);
      return member != null &&
             member.status == 'active' &&
             member.roles.hasAny(['administrator']) &&
             (member.stableAccess == 'all' ||
              (member.stableAccess == 'specific' && member.assignedStableIds.hasAny([stableId])));
    }

    // Check if user can MANAGE a stable (owner OR organization administrator)
    function canManageStable(stableId) {
      return isSystemAdmin() || isStableOwnerOf(stableId) || isOrgAdminForStable(stableId);
    }

    // Check if user can ACCESS stable (owner OR organization member with stable access)
    function canAccessStable(stableId) {
      return isSystemAdmin() ||
             isStableOwnerOf(stableId) ||
             hasOrgStableAccess(stableId);
    }

    // ============================================================================
    // ORGANIZATION HELPERS
    // ============================================================================

    // Check if user is the OWNER of a specific organization
    // Uses organizationMembers collection to avoid circular dependency
    function isOrganizationOwner(organizationId) {
      let memberId = request.auth.uid + '_' + organizationId;
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/organizationMembers/$(memberId)) &&
        get(/databases/$(database)/documents/organizationMembers/$(memberId)).data.roles.hasAny(['owner']);
    }

    // Get organization member document for current user
    function getOrganizationMember(organizationId) {
      let memberId = request.auth.uid + '_' + organizationId;
      return exists(/databases/$(database)/documents/organizationMembers/$(memberId))
        ? get(/databases/$(database)/documents/organizationMembers/$(memberId)).data
        : null;
    }

    // Check if user is an active MEMBER of a specific organization
    function isOrganizationMember(organizationId) {
      let member = getOrganizationMember(organizationId);
      return member != null && member.status == 'active';
    }

    // Check if user has a specific ROLE in an organization
    function hasOrganizationRole(organizationId, role) {
      let member = getOrganizationMember(organizationId);
      return member != null &&
             member.status == 'active' &&
             member.roles.hasAny([role]);
    }

    // Check if user is administrator of an organization
    function isOrganizationAdministrator(organizationId) {
      return hasOrganizationRole(organizationId, 'administrator');
    }

    // ============================================================================
    // USERS COLLECTION
    // ============================================================================

    match /users/{userId} {
      // Read: Self + system_admin + shared stable members
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        isSystemAdmin()
      );

      // Create: Only during auth registration (via backend service account)
      allow create: if isAuthenticated() &&
        request.resource.data.uid == request.auth.uid;

      // Update: Self can update profile, but NOT systemRole or uid
      allow update: if isAuthenticated() && (
        isSystemAdmin() || // Admin can update anything
        (isOwner(userId) &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['systemRole', 'uid']))
      );

      // Delete: System admin only (GDPR compliance)
      allow delete: if isSystemAdmin();
    }

    // ============================================================================
    // STABLES COLLECTION - API-MANAGED (READ-ONLY FROM FRONTEND)
    // ============================================================================
    // All writes handled by backend API for consistent authorization

    match /stables/{stableId} {
      // LIST: Simple authentication check - let query filter results
      allow list: if isAuthenticated();

      // GET: Full access check including membership
      allow get: if canAccessStable(stableId);

      // WRITES: Backend API only (uses service account)
      allow create, update, delete: if false;
    }

    // ============================================================================
    // SHIFT TYPES COLLECTION - API-MANAGED (READ-ONLY FROM FRONTEND)
    // ============================================================================
    // All writes handled by backend API for consistent authorization

    match /shiftTypes/{shiftTypeId} {
      // LIST: Blocked - use API /api/v1/facility-reservations for centralized authorization
      allow list: if isAuthenticated();

      // GET: Full access check - stable members only
      allow get: if canAccessStable(resource.data.stableId);

      // WRITES: Backend API only (uses service account)
      allow create, update, delete: if false;
    }

    // ============================================================================
    // SCHEDULES COLLECTION - MANAGER PERMISSIONS
    // ============================================================================

    match /schedules/{scheduleId} {
      // LIST: Blocked - use API /api/v1/schedules for centralized authorization
      allow list: if false;

      // GET: Full access check - stable members only
      allow get: if canAccessStable(resource.data.stableId);

      // CREATE: Owner or manager
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Owner or manager
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );

      // DELETE: Owner only
      allow delete: if isSystemAdmin() || isStableOwnerOf(resource.data.stableId);
    }

    // ============================================================================
    // SHIFTS COLLECTION - MEMBER SELF-BOOKING
    // ============================================================================

    match /shifts/{shiftId} {
      // LIST: Blocked - use API /api/v1/shifts for centralized authorization
      allow list: if false;

      // GET: Full access check - stable members only
      allow get: if canAccessStable(resource.data.stableId);

      // CREATE: Owner or manager
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Owner/manager can update anything, members can self-book unassigned shifts
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId) || // Owner/manager full control
        (canAccessStable(resource.data.stableId) && // Member self-booking
         resource.data.status == 'unassigned' &&
         request.resource.data.assignedTo == request.auth.uid &&
         request.resource.data.status == 'assigned')
      );

      // DELETE: Owner only
      allow delete: if isSystemAdmin() || isStableOwnerOf(resource.data.stableId);
    }

    // ============================================================================
    // BOOKINGS COLLECTION - FIXED
    // ============================================================================

    match /bookings/{bookingId} {
      // LIST: Simple authentication check - let query filter results
      allow list: if isAuthenticated();

      // GET: Full access check - stable members only
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // CREATE: Any stable member can create booking for themselves
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        (canAccessStable(request.resource.data.stableId) &&
         request.resource.data.userId == request.auth.uid) // Can only create for self
      );

      // UPDATE: Self or owner/manager
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        isOwner(resource.data.userId) ||
        canManageStable(resource.data.stableId)
      );

      // DELETE: Self or owner/manager
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        isOwner(resource.data.userId) ||
        canManageStable(resource.data.stableId)
      );
    }

    // ============================================================================
    // NOTIFICATIONS COLLECTION - USER-SCOPED
    // ============================================================================

    match /notifications/{notificationId} {
      // READ: Only notification recipient
      allow read: if isAuthenticated() && isOwner(resource.data.userId);

      // CREATE: Backend only (via Cloud Functions with service account)
      allow create: if false; // Backend uses service account

      // UPDATE: Only recipient can mark as read or dismiss
      allow update: if isAuthenticated() &&
        isOwner(resource.data.userId) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt', 'dismissed', 'dismissedAt', 'updatedAt']);

      // DELETE: Only recipient or system_admin (cleanup)
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        isOwner(resource.data.userId)
      );
    }

    // ============================================================================
    // INVITES COLLECTION - UNIFIED (STABLE + ORGANIZATION INVITES)
    // ============================================================================
    // Supports both stable invites (stableId field) and organization invites (organizationId field)

    match /invites/{inviteId} {
      // Helper: Check if this is a stable invite
      function isStableInvite() {
        return resource.data.keys().hasAny(['stableId']) && resource.data.stableId != null;
      }

      // Helper: Check if this is an organization invite
      function isOrgInvite() {
        return resource.data.keys().hasAny(['organizationId']) && resource.data.organizationId != null;
      }

      // Helper: Get invitee email (supports both field names)
      function getInviteeEmail() {
        return resource.data.keys().hasAny(['inviteeEmail'])
          ? resource.data.inviteeEmail
          : resource.data.email;
      }

      // LIST: Blocked - use API /api/v1/invites for centralized authorization
      allow list: if false;

      // GET: Managers/admins of the related entity OR the recipient
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        // Stable invite: stable managers or invitee
        (isStableInvite() && (
          canManageStable(resource.data.stableId) ||
          resource.data.inviteeEmail == request.auth.token.email
        )) ||
        // Organization invite: org members or invitee
        (isOrgInvite() && (
          isOrganizationMember(resource.data.organizationId) ||
          resource.data.email == request.auth.token.email
        ))
      );

      // CREATE: Managers/admins of the related entity
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        // Stable invite
        (request.resource.data.keys().hasAny(['stableId']) &&
         request.resource.data.stableId != null &&
         canManageStable(request.resource.data.stableId) &&
         request.resource.data.inviterId == request.auth.uid) ||
        // Organization invite
        (request.resource.data.keys().hasAny(['organizationId']) &&
         request.resource.data.organizationId != null &&
         (isOrganizationOwner(request.resource.data.organizationId) ||
          isOrganizationAdministrator(request.resource.data.organizationId)))
      );

      // UPDATE: Recipient can accept/decline, managers can cancel
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        // Stable invite: recipient accepts/declines OR manager cancels
        (isStableInvite() && (
          (resource.data.inviteeEmail == request.auth.token.email &&
           request.resource.data.status in ['accepted', 'declined']) ||
          (canManageStable(resource.data.stableId) &&
           request.resource.data.status == 'expired')
        )) ||
        // Organization invite: admin updates OR recipient updates status
        (isOrgInvite() && (
          isOrganizationOwner(resource.data.organizationId) ||
          isOrganizationAdministrator(resource.data.organizationId) ||
          (resource.data.email == request.auth.token.email &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'respondedAt']))
        ))
      );

      // DELETE: Owners/admins of the related entity
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        (isStableInvite() && isStableOwnerOf(resource.data.stableId)) ||
        (isOrgInvite() && (
          isOrganizationOwner(resource.data.organizationId) ||
          isOrganizationAdministrator(resource.data.organizationId)
        ))
      );
    }

    // ============================================================================
    // STABLE MEMBERS COLLECTION - DEPRECATED
    // ============================================================================
    // NOTE: stableMembers collection has been replaced by organizationMembers.
    // Stable access is now controlled via organizationMembers.stableAccess and
    // organizationMembers.assignedStableIds fields.
    // This collection is kept read-only for backward compatibility during migration.

    match /stableMembers/{memberId} {
      // All operations disabled - collection is deprecated
      allow read, write: if false;
    }

    // ============================================================================
    // HORSES COLLECTION - API-MANAGED (READ-ONLY FROM FRONTEND)
    // ============================================================================
    // All writes handled by backend API for consistent authorization

    match /horses/{horseId} {
      // LIST: Force backend API for listing to prevent enumeration
      // Backend will filter by ownership and stable membership
      allow list: if false;

      // GET: Full access check - owner or stable members if assigned
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.ownerId == request.auth.uid ||
        (resource.data.currentStableId != null &&
         canAccessStable(resource.data.currentStableId))
      );

      // WRITES: Backend API only (uses service account)
      allow create, update, delete: if false;
    }

    // ============================================================================
    // LOCATION HISTORY SUBCOLLECTION - API-MANAGED (READ-ONLY FROM FRONTEND)
    // ============================================================================
    // All writes handled by backend API as part of horse operations
    // Note: Using {path=**} to support both direct queries and collectionGroup queries

    match /{path=**}/locationHistory/{entryId} {
      // LIST: Disabled to prevent collectionGroup enumeration attacks
      // Backend API handles location history queries with proper filtering
      allow list: if false;

      // GET: Horse owner or stable members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.horseId != null &&
        get(/databases/$(database)/documents/horses/$(resource.data.horseId)).data.ownerId == request.auth.uid ||
        (resource.data.stableId != null &&
         canAccessStable(resource.data.stableId))
      );

      // WRITES: Backend API only (uses service account)
      allow create, update, delete: if false;
    }

    // ============================================================================
    // ORGANIZATIONS COLLECTION - ORGANIZATION MANAGEMENT
    // ============================================================================

    match /organizations/{organizationId} {
      // Helper: Validate organizationType field
      function isValidOrganizationType(data) {
        return !data.keys().hasAny(['organizationType']) ||
               data.organizationType in ['personal', 'business'];
      }

      // Helper: Check if organizationType is being changed (not allowed)
      function isOrganizationTypeUnchanged() {
        return !request.resource.data.diff(resource.data).affectedKeys().hasAny(['organizationType']) ||
               resource.data.organizationType == null; // Allow setting if previously unset
      }

      // LIST: Users can list organizations they own (for stable access resolution)
      // The query must filter by ownerId == request.auth.uid
      allow list: if isAuthenticated();

      // GET: Only organization members or system admins
      // Users can only access organizations they are members of
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationMember(organizationId)
      );

      // CREATE: Only users with stable_owner role or system admins can create organizations
      // User must become the ownerId
      // organizationType must be valid if provided
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        hasStableOwnerRole()
      ) &&
      request.resource.data.ownerId == request.auth.uid &&
      isValidOrganizationType(request.resource.data);

      // UPDATE: Organization owner or administrators
      // Prevent ownerId changes
      // organizationType cannot be changed once set (upgrade uses special endpoint)
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(organizationId) ||
        isOrganizationAdministrator(organizationId)
      ) &&
      request.resource.data.ownerId == resource.data.ownerId && // ownerId immutable
      isOrganizationTypeUnchanged(); // organizationType immutable (use upgrade endpoint)

      // DELETE: Only organization owner or system_admin
      allow delete: if isSystemAdmin() || isOrganizationOwner(organizationId);
    }

    // ============================================================================
    // ORGANIZATION MEMBERS COLLECTION - MEMBERSHIP MANAGEMENT
    // ============================================================================

    match /organizationMembers/{memberId} {
      // Validate memberId format: {userId}_{organizationId}
      function isValidMemberId() {
        return memberId.matches('^[a-zA-Z0-9]+_[a-zA-Z0-9]+$');
      }

      function extractOrganizationId() {
        return memberId.split('_')[1];
      }

      function extractUserId() {
        return memberId.split('_')[0];
      }

      // LIST: Blocked - use API /api/v1/organizations/:id/members for centralized authorization
      allow list: if false;

      // GET: Restricted to organization members, system admins, or user reading their own membership
      // Users can only access memberships in organizations they belong to or their own membership records
      allow get: if isAuthenticated() && isValidMemberId() && (
        isSystemAdmin() ||
        isOrganizationMember(extractOrganizationId()) ||
        isOwner(extractUserId())
      );

      // CREATE: Organization owner or administrators can invite
      // Validate memberId matches data fields
      allow create: if isAuthenticated() && isValidMemberId() && (
        isSystemAdmin() ||
        isOrganizationOwner(request.resource.data.organizationId) ||
        isOrganizationAdministrator(request.resource.data.organizationId)
      ) &&
      // Validation: memberId matches data
      extractUserId() == request.resource.data.userId &&
      extractOrganizationId() == request.resource.data.organizationId;

      // UPDATE: Owner/admin can change anything, member can update own status
      allow update: if isAuthenticated() && isValidMemberId() && (
        isSystemAdmin() ||
        isOrganizationOwner(resource.data.organizationId) || // Owner full control
        isOrganizationAdministrator(resource.data.organizationId) || // Admin full control
        (isOwner(extractUserId()) && // Member can update own status
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']))
      ) &&
      // Prevent changes to immutable fields
      request.resource.data.organizationId == resource.data.organizationId &&
      request.resource.data.userId == resource.data.userId;

      // DELETE: Organization owner, administrators, or self-remove
      allow delete: if isAuthenticated() && isValidMemberId() && (
        isSystemAdmin() ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId) ||
        isOwner(extractUserId())
      );
    }

    // ============================================================================
    // FACILITIES COLLECTION - STABLE-SCOPED
    // ============================================================================

    match /facilities/{facilityId} {
      // LIST: Blocked - use API /api/v1/facility-reservations for centralized authorization
      allow list: if isAuthenticated();

      // GET: Full access check - stable members only
      allow get: if canAccessStable(resource.data.stableId);

      // CREATE: Owner or manager
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Owner or manager
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );

      // DELETE: Owner only
      allow delete: if isSystemAdmin() || isStableOwnerOf(resource.data.stableId);
    }

    // ============================================================================
    // FACILITY RESERVATIONS COLLECTION - MEMBER SELF-BOOKING
    // ============================================================================

    match /facilityReservations/{reservationId} {
      // LIST: Blocked - use API /api/v1/facility-reservations for centralized authorization
      allow list: if false;

      // GET: Full access check - stable members or reservation owner
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId) ||
        resource.data.userId == request.auth.uid
      );

      // CREATE: Any stable member can create reservation for themselves
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        (canAccessStable(request.resource.data.stableId) &&
         request.resource.data.userId == request.auth.uid) // Can only create for self
      );

      // UPDATE: Self or owner/manager
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        isOwner(resource.data.userId) ||
        canManageStable(resource.data.stableId)
      );

      // DELETE: Self or owner/manager
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        isOwner(resource.data.userId) ||
        canManageStable(resource.data.stableId)
      );
    }

    // ============================================================================
    // ACTIVITY TYPES COLLECTION - STABLE-SCOPED CONFIGURATION
    // ============================================================================

    match /activityTypes/{activityTypeId} {
      // LIST: Force backend API for listing to prevent enumeration
      // Backend will filter by stable membership
      allow list: if false;

      // GET: Full access check - stable members only
      allow get: if canAccessStable(resource.data.stableId);

      // CREATE: Owner or manager
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Owner or manager
      // IMPORTANT: Standard types have field-level restrictions
      // Standard types can only modify: color, icon, isActive, sortOrder
      // Custom types can modify all fields except stableId, isStandard
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      ) &&
      // Prevent changing stableId and isStandard flag
      request.resource.data.stableId == resource.data.stableId &&
      request.resource.data.isStandard == resource.data.isStandard &&
      // Standard types: Only allow specific field changes
      (!resource.data.isStandard ||
       request.resource.data.diff(resource.data).affectedKeys()
         .hasOnly(['color', 'icon', 'isActive', 'sortOrder', 'updatedAt', 'lastModifiedBy']));

      // DELETE: Owner only, and CANNOT delete standard types (hard delete)
      // Standard types use soft delete via isActive field
      allow delete: if isSystemAdmin() || (
        isStableOwnerOf(resource.data.stableId) &&
        !resource.data.isStandard // No hard delete of standard types
      );
    }

    // ============================================================================
    // ACTIVITIES COLLECTION - POLYMORPHIC (ACTIVITIES, TASKS, MESSAGES)
    // ============================================================================

    match /activities/{activityId} {
      // LIST: Force backend API for listing to prevent enumeration
      // Backend will filter by stable membership
      allow list: if false;

      // GET: Full access check - any stable member can read
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // CREATE: Any stable member can create for their stable
      // Can assign to self or others if manager
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        (canAccessStable(request.resource.data.stableId) &&
         (request.resource.data.assignedTo == null ||
          request.resource.data.assignedTo == request.auth.uid ||
          canManageStable(request.resource.data.stableId)))
      );

      // UPDATE: Creator, assignee, or manager
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId) ||
        resource.data.createdBy == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid
      );

      // DELETE: Creator, manager, or owner
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        isStableOwnerOf(resource.data.stableId) ||
        canManageStable(resource.data.stableId) ||
        resource.data.createdBy == request.auth.uid
      );
    }

    // ============================================================================
    // RECURRING ACTIVITIES COLLECTION - PATTERN DEFINITIONS
    // ============================================================================

    match /recurringActivities/{activityId} {
      // LIST: Force backend API for listing to prevent enumeration
      // Backend will filter by stable membership
      allow list: if false;

      // GET: Full access check - stable members only
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // CREATE: Owner or manager only
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Owner or manager only
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );

      // DELETE: Owner or manager only
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );
    }

    // ============================================================================
    // ACTIVITY INSTANCES COLLECTION - MATERIALIZED INSTANCES (60-DAY WINDOW)
    // ============================================================================

    match /activityInstances/{instanceId} {
      // LIST: Force backend API for listing to prevent enumeration
      // Backend will filter by stable membership and date range
      allow list: if false;

      // GET: Full access check - stable members only
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // CREATE: Backend only (via Cloud Functions with service account)
      // Instances are generated by scheduled Cloud Functions
      allow create: if false;

      // UPDATE: Stable members can update status, assignee, progress
      // Managers can update all fields
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId) || // Manager full control
        (canAccessStable(resource.data.stableId) && // Members can update limited fields
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['status', 'completedAt', 'completedBy', 'progress', 'checklist', 'notes', 'updatedAt']))
      );

      // DELETE: Backend only (via Cloud Functions)
      // Instances are cleaned up by scheduled Cloud Functions
      allow delete: if false;
    }

    // ============================================================================
    // RECURRING ACTIVITY EXCEPTIONS COLLECTION - CANCELLATIONS/MODIFICATIONS
    // ============================================================================

    match /recurringActivityExceptions/{exceptionId} {
      // LIST: Force backend API for listing
      allow list: if false;

      // GET: Full access check - stable members only
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // CREATE: Owner or manager only
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Owner or manager only
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );

      // DELETE: Owner or manager only
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );
    }

    // ============================================================================
    // NOTIFICATION QUEUE COLLECTION - BACKEND PROCESSING QUEUE
    // ============================================================================

    match /notificationQueue/{queueId} {
      // Backend only - all operations via service account
      // Queue items are created by reminder scanner and processed by delivery function
      allow read, write: if false;
    }

    // ============================================================================
    // SENT REMINDERS COLLECTION - DEDUPLICATION TRACKING
    // ============================================================================

    match /sentReminders/{reminderId} {
      // Backend only - all operations via service account
      // Used to prevent duplicate reminder sending
      allow read, write: if false;
    }

    // ============================================================================
    // USER PREFERENCES SUBCOLLECTION - NOTIFICATION & OTHER SETTINGS
    // ============================================================================

    match /users/{userId}/preferences/{prefId} {
      // READ: Only user can read their preferences
      allow read: if isAuthenticated() && isOwner(userId);

      // CREATE/UPDATE: Only user can manage their preferences
      allow create, update: if isAuthenticated() && isOwner(userId);

      // DELETE: Only user can delete their preferences
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ============================================================================
    // USER SETTINGS SUBCOLLECTION - CROSS-DEVICE SYNCHRONIZED SETTINGS
    // ============================================================================
    // Stores user preferences like default stable, language, etc.
    // Path: users/{userId}/settings/preferences

    match /users/{userId}/settings/{settingId} {
      // READ: Only user can read their settings
      allow read: if isAuthenticated() && isOwner(userId);

      // CREATE/UPDATE: Only user can manage their settings
      allow create, update: if isAuthenticated() && isOwner(userId);

      // DELETE: Only user can delete their settings
      allow delete: if isAuthenticated() && isOwner(userId);
    }

    // ============================================================================
    // NOTIFICATIONS ARCHIVE COLLECTION - LONG-TERM STORAGE
    // ============================================================================

    match /notificationsArchive/{notificationId} {
      // READ: Only notification recipient or system admin
      allow read: if isAuthenticated() && (
        isSystemAdmin() ||
        isOwner(resource.data.userId)
      );

      // CREATE: Backend only (via Cloud Functions cleanup)
      allow create: if false;

      // UPDATE: No updates to archived notifications
      allow update: if false;

      // DELETE: System admin only (GDPR compliance)
      allow delete: if isSystemAdmin();
    }

    // ============================================================================
    // HORSE GROUPS COLLECTION - API-MANAGED (READ-ONLY FROM FRONTEND)
    // ============================================================================
    // All writes handled by backend API for consistent authorization

    match /horseGroups/{groupId} {
      // LIST: All authenticated users can list (filtering happens client-side)
      allow list: if isAuthenticated();

      // GET: Organization members can read
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationMember(resource.data.organizationId)
      );

      // WRITES: Backend API only (uses service account)
      allow create, update, delete: if false;
    }

    // ============================================================================
    // VACCINATION RULES COLLECTION - MULTI-SCOPE (SYSTEM, ORGANIZATION, USER)
    // ============================================================================

    match /vaccinationRules/{ruleId} {
      // Helper function to check if user is organization owner or admin
      function isOrgAdminOrOwner(orgId) {
        let org = get(/databases/$(database)/documents/organizations/$(orgId));
        let isOwner = org.data.ownerId == request.auth.uid;
        let membership = get(/databases/$(database)/documents/organizationMembers/$(request.auth.uid + '_' + orgId));
        let isAdmin = membership.data.roles.hasAny(['administrator']);
        return isOwner || isAdmin;
      }

      // LIST: All authenticated users can list (filtering happens client-side)
      allow list: if isAuthenticated();

      // GET: Scope-based read permissions
      allow get: if isAuthenticated() && (
        // System rules: everyone can read
        (resource.data.scope == 'system') ||
        // Organization rules: org members can read
        (resource.data.scope == 'organization' &&
         exists(/databases/$(database)/documents/organizationMembers/$(request.auth.uid + '_' + resource.data.organizationId))) ||
        // User rules: owner only
        (resource.data.scope == 'user' && resource.data.userId == request.auth.uid)
      );

      // CREATE: Org owners/admins for org rules, users for their own rules
      allow create: if isAuthenticated() && (
        (request.resource.data.scope == 'organization' &&
         isOrgAdminOrOwner(request.resource.data.organizationId)) ||
        (request.resource.data.scope == 'user' &&
         request.resource.data.userId == request.auth.uid)
      );

      // UPDATE: Cannot update system rules, owners/admins for org rules, users for their own
      allow update: if isAuthenticated() && resource.data.scope != 'system' && (
        (resource.data.scope == 'organization' && isOrgAdminOrOwner(resource.data.organizationId)) ||
        (resource.data.scope == 'user' && resource.data.userId == request.auth.uid)
      );

      // DELETE: Cannot delete system rules, owners/admins for org rules, users for their own
      allow delete: if isAuthenticated() && (
        (resource.data.scope == 'organization' && isOrgAdminOrOwner(resource.data.organizationId)) ||
        (resource.data.scope == 'user' && resource.data.userId == request.auth.uid)
      );
    }

    // ============================================================================
    // VACCINATION RECORDS COLLECTION - HORSE HEALTH TRACKING
    // ============================================================================

    match /vaccinationRecords/{recordId} {
      // Helper function to check if user is horse owner
      function isHorseOwner(horseId) {
        return exists(/databases/$(database)/documents/horses/$(horseId)) &&
               get(/databases/$(database)/documents/horses/$(horseId)).data.ownerId == request.auth.uid;
      }

      // Helper function to check organization role
      function hasOrgRole(orgId, role) {
        let memberId = request.auth.uid + '_' + orgId;
        return exists(/databases/$(database)/documents/organizationMembers/$(memberId)) &&
               get(/databases/$(database)/documents/organizationMembers/$(memberId)).data.roles.hasAny([role]);
      }

      // LIST: All authenticated users can list (filtering happens client-side)
      allow list: if isAuthenticated();

      // GET: Organization members with specific roles or horse owner
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        // Organization members with veterinary/admin/customer/horse_owner roles
        hasOrgRole(resource.data.organizationId, 'administrator') ||
        hasOrgRole(resource.data.organizationId, 'veterinarian') ||
        hasOrgRole(resource.data.organizationId, 'customer') ||
        hasOrgRole(resource.data.organizationId, 'horse_owner') ||
        // Horse owner can view their horse's vaccination records
        isHorseOwner(resource.data.horseId)
      );

      // CREATE: Organization administrators and veterinarians only
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        hasOrgRole(request.resource.data.organizationId, 'administrator') ||
        hasOrgRole(request.resource.data.organizationId, 'veterinarian')
      ) &&
      // Validation: ensure correct horse and organization
      isHorseOwner(request.resource.data.horseId) || (
        hasOrgRole(request.resource.data.organizationId, 'administrator') ||
        hasOrgRole(request.resource.data.organizationId, 'veterinarian')
      );

      // UPDATE: Organization administrators and veterinarians only
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        hasOrgRole(resource.data.organizationId, 'administrator') ||
        hasOrgRole(resource.data.organizationId, 'veterinarian')
      );

      // DELETE: Organization administrators and veterinarians only
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        hasOrgRole(resource.data.organizationId, 'administrator') ||
        hasOrgRole(resource.data.organizationId, 'veterinarian')
      );
    }

    // ============================================================================
    // CONTACTS COLLECTION - MULTI-LEVEL ACCESS (ORGANIZATION & USER)
    // ============================================================================

    match /contacts/{contactId} {
      // Helper: Check if organization is a business org (not personal)
      function isBusinessOrganization(orgId) {
        return exists(/databases/$(database)/documents/organizations/$(orgId)) &&
               get(/databases/$(database)/documents/organizations/$(orgId)).data.organizationType == 'business';
      }

      // LIST: Blocked - use API /api/v1/contacts for centralized authorization
      allow list: if false;

      // GET: Read if:
      // 1. Organization contact and user is member of that organization
      // 2. User contact and user is the owner
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        (resource.data.accessLevel == 'organization' &&
         resource.data.organizationId != null &&
         isOrganizationMember(resource.data.organizationId)) ||
        (resource.data.accessLevel == 'user' &&
         resource.data.userId != null &&
         resource.data.userId == request.auth.uid)
      );

      // CREATE: Create if:
      // 1. Creating organization contact and user is org owner/admin AND org is business type
      // 2. Creating user contact for themselves
      // NOTE: Personal orgs cannot create org-level contacts - they must use user-level
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        (request.resource.data.accessLevel == 'organization' &&
         request.resource.data.organizationId != null &&
         isBusinessOrganization(request.resource.data.organizationId) &&
         (isOrganizationOwner(request.resource.data.organizationId) ||
          isOrganizationAdministrator(request.resource.data.organizationId)) &&
         request.resource.data.createdBy == request.auth.uid) ||
        (request.resource.data.accessLevel == 'user' &&
         request.resource.data.userId == request.auth.uid &&
         request.resource.data.createdBy == request.auth.uid)
      );

      // UPDATE: Update if creator or org admin
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        (resource.data.accessLevel == 'organization' &&
         resource.data.organizationId != null &&
         exists(/databases/$(database)/documents/organizations/$(resource.data.organizationId)) &&
         (isOrganizationOwner(resource.data.organizationId) ||
          isOrganizationAdministrator(resource.data.organizationId)))
      );

      // DELETE: Delete if creator or org admin
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        (resource.data.accessLevel == 'organization' &&
         resource.data.organizationId != null &&
         exists(/databases/$(database)/documents/organizations/$(resource.data.organizationId)) &&
         (isOrganizationOwner(resource.data.organizationId) ||
          isOrganizationAdministrator(resource.data.organizationId)))
      );
    }

    // ============================================================================
    // FEED TYPES COLLECTION - STABLE-SCOPED CONFIGURATION
    // ============================================================================

    match /feedTypes/{feedTypeId} {
      // LIST: Authenticated users (filtering by stableId happens in query)
      allow list: if isAuthenticated();

      // GET: Full access check - stable members only
      allow get: if canAccessStable(resource.data.stableId);

      // CREATE: Owner or manager
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Owner or manager
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );

      // DELETE: Owner or manager
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );
    }

    // ============================================================================
    // FEEDING TIMES COLLECTION - STABLE-SCOPED CONFIGURATION
    // ============================================================================

    match /feedingTimes/{feedingTimeId} {
      // LIST: Authenticated users (filtering by stableId happens in query)
      allow list: if isAuthenticated();

      // GET: Full access check - stable members only
      allow get: if canAccessStable(resource.data.stableId);

      // CREATE: Owner or manager
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Owner or manager
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );

      // DELETE: Owner or manager
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );
    }

    // ============================================================================
    // HORSE FEEDINGS COLLECTION - HORSE FEEDING SCHEDULES
    // ============================================================================

    match /horseFeedings/{horseFeedingId} {
      // LIST: Authenticated users (filtering by stableId/horseId happens in query)
      allow list: if isAuthenticated();

      // GET: Full access check - stable members only
      allow get: if canAccessStable(resource.data.stableId);

      // CREATE: Any stable member can create feedings
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(request.resource.data.stableId)
      );

      // UPDATE: Stable member or manager
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // DELETE: Stable member or manager
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );
    }

    // ============================================================================
    // LEAVE REQUESTS COLLECTION - AVAILABILITY MANAGEMENT
    // ============================================================================

    match /leaveRequests/{requestId} {
      // LIST: Force backend API for listing to prevent cross-org enumeration
      // Backend will filter by userId or organizationId with proper authorization
      allow list: if false;

      // GET: User can read their own requests, admins can read all in org
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.userId == request.auth.uid ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );

      // CREATE: Users can create their own leave requests
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        (request.resource.data.userId == request.auth.uid &&
         isOrganizationMember(request.resource.data.organizationId))
      );

      // UPDATE: User can update pending requests, admins can approve/reject
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        // User can update their own pending requests (cancel, edit note)
        (resource.data.userId == request.auth.uid &&
         resource.data.status == 'pending') ||
        // Admins can approve/reject requests
        (isOrganizationOwner(resource.data.organizationId) ||
         isOrganizationAdministrator(resource.data.organizationId))
      );

      // DELETE: User can delete their own pending requests, admins can delete any
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        (resource.data.userId == request.auth.uid &&
         resource.data.status == 'pending') ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );
    }

    // ============================================================================
    // WORK SCHEDULES COLLECTION - EMPLOYEE SCHEDULES
    // ============================================================================

    match /workSchedules/{scheduleId} {
      // LIST: Force backend API for listing to prevent cross-org enumeration
      // Backend will filter by userId or organizationId with proper authorization
      allow list: if false;

      // GET: User can read their own schedule, admins can read all in org
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.userId == request.auth.uid ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );

      // CREATE: Only admins can create work schedules
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(request.resource.data.organizationId) ||
        isOrganizationAdministrator(request.resource.data.organizationId)
      );

      // UPDATE: Only admins can update work schedules
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );

      // DELETE: Only admins can delete work schedules
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );
    }

    // ============================================================================
    // TIME BALANCES COLLECTION - LEAVE BALANCE TRACKING
    // ============================================================================

    match /timeBalances/{balanceId} {
      // LIST: Force backend API for listing to prevent cross-org enumeration
      // Backend will filter by userId or organizationId with proper authorization
      allow list: if false;

      // GET: User can read their own balance, admins can read all in org
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.userId == request.auth.uid ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );

      // CREATE: Backend/admins only (created by accrual system)
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(request.resource.data.organizationId) ||
        isOrganizationAdministrator(request.resource.data.organizationId)
      );

      // UPDATE: Only admins can update balances (corrections)
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );

      // DELETE: Only system admin (balance records should be retained)
      allow delete: if isSystemAdmin();
    }

    // ============================================================================
    // BALANCE ADJUSTMENTS COLLECTION - AUDIT TRAIL FOR BALANCE CHANGES
    // ============================================================================

    match /balanceAdjustments/{adjustmentId} {
      // LIST: Only admins can list adjustments
      allow list: if isAuthenticated() && (
        isSystemAdmin()
      );

      // GET: User can read their own adjustments, admins can read all in org
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.userId == request.auth.uid ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );

      // CREATE: Only admins can create adjustments (via backend)
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(request.resource.data.organizationId) ||
        isOrganizationAdministrator(request.resource.data.organizationId)
      );

      // UPDATE: Balance adjustments are immutable - no updates allowed
      allow update: if false;

      // DELETE: Balance adjustments are immutable - no deletions allowed
      allow delete: if false;
    }

    // ============================================================================
    // HEALTH RECORDS COLLECTION - HORSE MEDICAL HISTORY
    // ============================================================================

    match /healthRecords/{recordId} {
      // Helper function to check if user has access to the horse
      function canAccessHorse(horseId) {
        let horse = get(/databases/$(database)/documents/horses/$(horseId));
        return horse.data.ownerId == request.auth.uid ||
               (horse.data.currentStableId != null &&
                canAccessStable(horse.data.currentStableId));
      }

      // LIST: Blocked - use API /api/v1/health-records for centralized authorization
      allow list: if false;

      // GET: Horse owner or stable members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(resource.data.horseId)
      );

      // CREATE: Horse owner or stable managers
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(request.resource.data.horseId)
      );

      // UPDATE: Horse owner or stable managers
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(resource.data.horseId)
      );

      // DELETE: Horse owner or stable managers
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(resource.data.horseId)
      );
    }

    // ============================================================================
    // HORSE OWNERSHIP COLLECTION - MULTI-OWNER TRACKING
    // ============================================================================

    match /horseOwnership/{ownershipId} {
      // Helper function to check if user has access to the horse
      function canAccessHorse(horseId) {
        let horse = get(/databases/$(database)/documents/horses/$(horseId));
        return horse.data.ownerId == request.auth.uid ||
               (horse.data.currentStableId != null &&
                canAccessStable(horse.data.currentStableId));
      }

      // LIST: Blocked - use API /api/v1/horse-ownership for centralized authorization
      allow list: if false;

      // GET: Horse owner or stable members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(resource.data.horseId)
      );

      // CREATE: Horse owner or stable managers only
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(request.resource.data.horseId)
      );

      // UPDATE: Horse owner or stable managers only
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(resource.data.horseId)
      );

      // DELETE: Horse owner or stable managers only
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(resource.data.horseId)
      );
    }

    // ============================================================================
    // HORSE MEDIA COLLECTION - DOCUMENTS, PHOTOS, VIDEOS
    // ============================================================================

    match /horseMedia/{mediaId} {
      // Helper function to check if user has access to the horse
      function canAccessHorse(horseId) {
        let horse = get(/databases/$(database)/documents/horses/$(horseId));
        return horse.data.ownerId == request.auth.uid ||
               (horse.data.currentStableId != null &&
                canAccessStable(horse.data.currentStableId));
      }

      // LIST: All authenticated users can list (filtering happens via query)
      allow list: if isAuthenticated();

      // GET: Horse owner or stable members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(resource.data.horseId)
      );

      // CREATE: Horse owner or stable members
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(request.resource.data.horseId)
      );

      // UPDATE: Horse owner or stable members (for favorites, etc.)
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse(resource.data.horseId)
      );

      // DELETE: Horse owner or uploader
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.uploadedBy == request.auth.uid ||
        canAccessHorse(resource.data.horseId)
      );
    }

    // ============================================================================
    // HORSE TACK SUBCOLLECTION - EQUIPMENT INVENTORY
    // ============================================================================
    // Stored as subcollection under horses/{horseId}/tack/{tackId}

    match /horses/{horseId}/tack/{tackId} {
      // Helper function to check if user has access to the horse
      function canAccessHorse() {
        let horse = get(/databases/$(database)/documents/horses/$(horseId));
        return horse.data.ownerId == request.auth.uid ||
               (horse.data.currentStableId != null &&
                canAccessStable(horse.data.currentStableId));
      }

      // LIST: Horse owner or stable members can list tack items
      allow list: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse()
      );

      // GET: Horse owner or stable members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse()
      );

      // CREATE: Horse owner or stable members
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse()
      );

      // UPDATE: Horse owner or stable members
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse()
      );

      // DELETE: Horse owner or stable members (soft delete via isActive field)
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessHorse()
      );
    }

    // ============================================================================
    // AUDIT LOGS COLLECTION - IMMUTABLE ACTIVITY TRACKING
    // ============================================================================

    match /auditLogs/{logId} {
      // LIST: System admins only (compliance and security auditing)
      allow list: if isSystemAdmin();

      // GET: System admins only
      allow get: if isSystemAdmin();

      // CREATE: Backend only (via Cloud Functions with service account)
      // Audit logs must be created by trusted backend services for integrity
      // Client-side audit log creation disabled for security
      allow create: if false;

      // UPDATE: Audit logs are immutable - no updates allowed
      allow update: if false;

      // DELETE: Audit logs are immutable - no deletions allowed
      allow delete: if false;
    }

    // ============================================================================
    // COMMUNICATION RECORDS COLLECTION - CONTACT INTERACTION HISTORY
    // ============================================================================

    match /communicationRecords/{recordId} {
      // LIST: Blocked - use API /api/v1/organizations/:id/communications for centralized authorization
      allow list: if false;

      // GET: Organization members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationMember(resource.data.organizationId)
      );

      // CREATE: Organization members can create
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        (isOrganizationMember(request.resource.data.organizationId) &&
         request.resource.data.createdBy == request.auth.uid)
      );

      // UPDATE: Creator or org admins can update
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );

      // DELETE: Creator or org admins can delete
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        resource.data.createdBy == request.auth.uid ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );
    }

    // ============================================================================
    // COMMUNICATION TEMPLATES COLLECTION - REUSABLE MESSAGE TEMPLATES
    // ============================================================================

    match /communicationTemplates/{templateId} {
      // LIST: Authenticated users (filtering by organizationId happens via query)
      allow list: if isAuthenticated();

      // GET: Organization members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationMember(resource.data.organizationId)
      );

      // CREATE: Organization admins only
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(request.resource.data.organizationId) ||
        isOrganizationAdministrator(request.resource.data.organizationId)
      );

      // UPDATE: Organization admins only
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );

      // DELETE: Organization admins only
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );
    }

    // ============================================================================
    // ROUTINE TEMPLATES COLLECTION - ORGANIZATION-SCOPED
    // ============================================================================

    match /routineTemplates/{templateId} {
      // LIST: Authenticated users (filtering by organizationId happens via query)
      allow list: if isAuthenticated();

      // GET: Organization members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationMember(resource.data.organizationId)
      );

      // CREATE: Organization admins only
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(request.resource.data.organizationId) ||
        isOrganizationAdministrator(request.resource.data.organizationId)
      );

      // UPDATE: Organization admins only
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );

      // DELETE: Organization admins only (soft delete via isActive)
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        isOrganizationOwner(resource.data.organizationId) ||
        isOrganizationAdministrator(resource.data.organizationId)
      );
    }

    // ============================================================================
    // ROUTINE INSTANCES COLLECTION - STABLE-SCOPED EXECUTION
    // ============================================================================

    match /routineInstances/{instanceId} {
      // LIST: Authenticated users (filtering by stableId happens via query)
      allow list: if isAuthenticated();

      // GET: Stable members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // CREATE: Stable managers or org admins
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Stable members can update progress, managers can update all
      // Members limited to status, progress, completedAt, completedBy fields
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId) || // Manager full control
        (canAccessStable(resource.data.stableId) && // Members limited update
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['status', 'startedAt', 'completedAt', 'completedBy',
                     'currentStepId', 'currentStepOrder', 'progress',
                     'dailyNotesAcknowledged', 'dailyNotesAcknowledgedAt',
                     'notes', 'updatedAt', 'updatedBy']))
      );

      // DELETE: Stable managers only
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );
    }

    // ============================================================================
    // ROUTINE SCHEDULES COLLECTION - STABLE-SCOPED RECURRING DEFINITIONS
    // ============================================================================

    match /routineSchedules/{scheduleId} {
      // LIST: Authenticated users (filtering by stableId happens via query)
      allow list: if isAuthenticated();

      // GET: Stable members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // CREATE: Stable managers or org admins
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(request.resource.data.stableId)
      );

      // UPDATE: Stable managers or org admins
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );

      // DELETE: Stable managers or org admins
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );
    }

    // ============================================================================
    // DAILY NOTES COLLECTION - STABLE-SCOPED COMMUNICATION
    // ============================================================================

    match /dailyNotes/{noteId} {
      // LIST: Blocked - use API /api/v1/daily-notes for centralized authorization
      allow list: if false;

      // GET: Stable members can view
      allow get: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // CREATE: Any stable member can create notes
      allow create: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(request.resource.data.stableId)
      );

      // UPDATE: Any stable member can update notes
      allow update: if isAuthenticated() && (
        isSystemAdmin() ||
        canAccessStable(resource.data.stableId)
      );

      // DELETE: Stable managers only
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        canManageStable(resource.data.stableId)
      );
    }

    // Default deny all
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
