rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // ============================================================================
    // HELPER FUNCTIONS (synchronized with Firestore rules)
    // ============================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // FIXED: Check 'systemRole' field instead of 'role'
    function hasRole(role) {
      return isAuthenticated() &&
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid))
          .data.systemRole == role;
    }

    function isSystemAdmin() {
      return hasRole('system_admin');
    }

    // Check if user is the OWNER of a specific stable
    function isStableOwnerOf(stableId) {
      return isAuthenticated() &&
        firestore.get(/databases/(default)/documents/stables/$(stableId))
          .data.ownerId == request.auth.uid;
    }

    // Get the org member doc for the current user in the stable's organization
    // Returns null if user is not a member
    function getOrgMemberForStable(stableId) {
      let orgId = firestore.get(/databases/(default)/documents/stables/$(stableId)).data.organizationId;
      let memberId = request.auth.uid + '_' + orgId;
      return firestore.get(/databases/(default)/documents/organizationMembers/$(memberId));
    }

    // Check if user is an active organization member with access to this stable
    function isOrganizationMemberWithStableAccess(stableId) {
      let member = getOrgMemberForStable(stableId);
      return isAuthenticated() &&
        member != null &&
        member.data.status == 'active' &&
        (member.data.stableAccess == 'all' ||
         stableId in member.data.assignedStableIds);
    }

    // Check if user is an org admin/manager with access to this stable
    function isOrganizationManagerWithStableAccess(stableId) {
      let member = getOrgMemberForStable(stableId);
      return isAuthenticated() &&
        member != null &&
        member.data.status == 'active' &&
        (member.data.stableAccess == 'all' ||
         stableId in member.data.assignedStableIds) &&
        (member.data.primaryRole == 'administrator' ||
         member.data.primaryRole == 'stable_manager');
    }

    // Can user access this stable's files? (admin, owner, or org member with access)
    function canAccessStableFiles(stableId) {
      return isSystemAdmin() || isStableOwnerOf(stableId) || isOrganizationMemberWithStableAccess(stableId);
    }

    // Can user manage this stable's files? (admin, owner, or org manager with access)
    function canManageStableFiles(stableId) {
      return isSystemAdmin() || isStableOwnerOf(stableId) || isOrganizationManagerWithStableAccess(stableId);
    }

    // ============================================================================
    // FILE VALIDATION HELPERS
    // ============================================================================

    function isValidImageSize() {
      return request.resource.size < 5 * 1024 * 1024; // 5MB
    }

    function isValidImageType() {
      return request.resource.contentType.matches('image/.*');
    }

    function isValidAttachmentSize() {
      return request.resource.size < 10 * 1024 * 1024; // 10MB
    }

    // ============================================================================
    // STORAGE RULES
    // ============================================================================

    // User profile images
    match /users/{userId}/profile/{imageId} {
      // READ: Authenticated users (for displaying avatars in shared stables)
      allow read: if isAuthenticated();

      // WRITE: Owner only + image validation
      allow write: if isOwner(userId) && isValidImageSize() && isValidImageType();

      // DELETE: Owner only
      allow delete: if isOwner(userId);
    }

    // Stable images (stable logo, photos)
    match /stables/{stableId}/images/{imageId} {
      // READ: Stable members only
      allow read: if canAccessStableFiles(stableId);

      // WRITE: Owner or manager + image validation
      allow write: if canManageStableFiles(stableId) && isValidImageSize() && isValidImageType();

      // DELETE: Owner only
      allow delete: if isStableOwnerOf(stableId);
    }

    // FIXED: Shift attachments with proper stable scoping
    // NEW PATH: /stables/{stableId}/shifts/{shiftId}/attachments/{fileId}
    match /stables/{stableId}/shifts/{shiftId}/attachments/{fileId} {
      // READ: Stable members only
      allow read: if canAccessStableFiles(stableId);

      // WRITE: Owner or manager + size validation
      allow write: if canManageStableFiles(stableId) && isValidAttachmentSize();

      // DELETE: Owner or manager
      allow delete: if canManageStableFiles(stableId);
    }

    // Horse files: images, profile photos, and media
    // Covers paths: /horses/{horseId}/images/*, /horses/{horseId}/profile/*, /horses/{horseId}/media/*
    match /horses/{horseId}/{subfolder}/{fileId} {
      // READ: Horse owner or stable members if assigned
      allow read: if isAuthenticated() && (
        isSystemAdmin() ||
        firestore.get(/databases/(default)/documents/horses/$(horseId)).data.ownerId == request.auth.uid ||
        (firestore.get(/databases/(default)/documents/horses/$(horseId)).data.currentStableId != null &&
         canAccessStableFiles(firestore.get(/databases/(default)/documents/horses/$(horseId)).data.currentStableId))
      );

      // WRITE: Horse owner only + image validation
      allow write: if isAuthenticated() && (
        isSystemAdmin() ||
        firestore.get(/databases/(default)/documents/horses/$(horseId)).data.ownerId == request.auth.uid
      ) && isValidImageSize() && isValidImageType();

      // DELETE: Horse owner only
      allow delete: if isAuthenticated() && (
        isSystemAdmin() ||
        firestore.get(/databases/(default)/documents/horses/$(horseId)).data.ownerId == request.auth.uid
      );
    }

    // Default deny all
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
